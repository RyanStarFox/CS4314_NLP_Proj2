name: Release App

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.id }}
    steps:
      - uses: actions/checkout@v4
      - name: Create Release
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          prerelease: false
          generate_release_notes: true

  build-tauri:
    needs: create-release
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # 1. Apple Silicon Mac
          - platform: 'macos-silicon'
            os: macos-latest
            target: 'aarch64-apple-darwin'
            tauri_args: '--target aarch64-apple-darwin'

          # 2. Intel Mac (Updated to macos-15-intel per deprecation notice)
          - platform: 'macos-intel'
            os: macos-15-intel
            target: 'x86_64-apple-darwin'
            tauri_args: '--target x86_64-apple-darwin'

          # 3. Windows x64
          - platform: 'windows-x64'
            os: windows-latest
            target: '' 
            tauri_args: '--bundles nsis'

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      # --- VERSION INJECTION LOGIC ---
      - name: Update Version from Tag (Mac/Reference)
        if: runner.os != 'Windows'
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "Syncing version to $VERSION"
          # Only replace "version": "..." lines that look like the main package version
          sed -i '' "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" desktop-app/src-tauri/tauri.conf.json
          # Only replace version = "..." at the start of the line (package version), ignore deps
          sed -i '' "s/^version = \".*\"/version = \"$VERSION\"/" desktop-app/src-tauri/Cargo.toml
        shell: bash

      - name: Update Version from Tag (Windows)
        if: runner.os == 'Windows'
        run: |
          $Version = $env:GITHUB_REF_NAME.TrimStart('v')
          Write-Host "Syncing version to $Version"
          
          $jsonPath = "desktop-app/src-tauri/tauri.conf.json"
          $tomlPath = "desktop-app/src-tauri/Cargo.toml"
          
          # JSON: specific key replacement
          (Get-Content $jsonPath) -replace '"version": ".*?"', "`"version`": `"$Version`"" | Set-Content $jsonPath
          
          # TOML: SAFE replacement. Only replace 'version = "..."' if it's the package version (start of line)
          # We manually iterate to ensure we don't accidentally replace dependency versions like serde = { version = "1" }
          $content = Get-Content $tomlPath
          $newContent = $content | ForEach-Object { 
              if ($_ -match '^version\s*=\s*".*"') { 
                  'version = "' + $Version + '"' 
              } else { 
                  $_ 
              } 
          }
          $newContent | Set-Content $tomlPath
        shell: powershell

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # FIX: Explicitly install NPM dependencies in correct directory
      - name: Install Frontend Dependencies
        working-directory: ./desktop-app
        run: npm install

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # --- PYTHON SETUP ---
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # FIX: Create dependencies manually since requirements.txt might be missing or unreadable
      # Using Python one-liner to check file existence is cross-platform safe
      - name: Install Python dependencies
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
             echo "Installing deps using explicit Python: $pythonLocation"
             "$pythonLocation/python" -m pip install --upgrade pip
             "$pythonLocation/python" -m pip install streamlit langchain langchain-community langchain-openai chromadb pandas numpy python-dotenv watchfiles pyinstaller beautifulsoup4 pypdf openai tiktoken
             # Optional requirements.txt check using the explicit python
             if [ -f requirements.txt ]; then "$pythonLocation/python" -m pip install -r requirements.txt; fi
          else
             python -m pip install --upgrade pip
             python -m pip install streamlit langchain langchain-community langchain-openai chromadb pandas numpy python-dotenv watchfiles pyinstaller beautifulsoup4 pypdf openai tiktoken
             python -c "import os; os.system('pip install -r requirements.txt') if os.path.exists('requirements.txt') else print('Skipping requirements.txt')"
          fi
        shell: bash

      # --- BACKEND BUILD ---
      - name: Build Python Backend
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
             # Windows: Use explicit python, rename output, copy metadata, AND bundle source files as data
             echo "Using Python at: $pythonLocation"
             "$pythonLocation/python" -m PyInstaller --clean --noconfirm --name python-backend --copy-metadata streamlit --copy-metadata chromadb --copy-metadata langchain --copy-metadata langchain-community --add-data "app.py;." --add-data "ui_components.py;." --add-data "config.py;." --add-data "settings_utils.py;." --add-data "pages;pages" --add-data "logo.png;." --distpath desktop-app/python-dist --workpath desktop-app/build app.py
             
             # Copy necessary data folders if they exist
             if [ -d "vector_db" ]; then cp -r vector_db desktop-app/python-dist/python-backend/; fi
             if [ -d "data" ]; then cp -r data desktop-app/python-dist/python-backend/; fi
          else
             # Mac/Linux: Standard invocation with rename AND copy metadata AND bundle source files
             pyinstaller --clean --noconfirm --name python-backend --copy-metadata streamlit --copy-metadata chromadb --copy-metadata langchain --copy-metadata langchain-community --add-data "app.py:." --add-data "ui_components.py:." --add-data "config.py:." --add-data "settings_utils.py:." --add-data "pages:pages" --add-data "logo.png:." --distpath desktop-app/python-dist --workpath desktop-app/build app.py
             chmod +x desktop-app/python-dist/python-backend/python-backend
             
             # Copy necessary data folders
             if [ -d "vector_db" ]; then cp -r vector_db desktop-app/python-dist/python-backend/; fi
             if [ -d "data" ]; then cp -r data desktop-app/python-dist/python-backend/; fi
          fi
        shell: bash

      # --- FRONTEND BUILD ---
      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: "./desktop-app"
          tagName: ${{ github.ref_name }}
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.tauri_args }}
